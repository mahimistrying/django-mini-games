{% extends 'base.html' %}

{% block title %}Tic Tac Toe{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="game-area">
            <h1 class="text-center mb-4">ðŸŽ® Tic Tac Toe</h1>
            
            <div class="text-center mb-3">
                <div class="score-display">
                    <span id="current-player">Current Player: <strong>X</strong></span>
                </div>
                <div class="mt-2">
                    <span id="game-status">Make your move!</span>
                </div>
            </div>

            <div class="tic-tac-toe-board" id="game-board">
                <button class="tic-tac-toe-cell" data-cell="0"></button>
                <button class="tic-tac-toe-cell" data-cell="1"></button>
                <button class="tic-tac-toe-cell" data-cell="2"></button>
                <button class="tic-tac-toe-cell" data-cell="3"></button>
                <button class="tic-tac-toe-cell" data-cell="4"></button>
                <button class="tic-tac-toe-cell" data-cell="5"></button>
                <button class="tic-tac-toe-cell" data-cell="6"></button>
                <button class="tic-tac-toe-cell" data-cell="7"></button>
                <button class="tic-tac-toe-cell" data-cell="8"></button>
            </div>

            <div class="text-center mt-4">
                <button id="reset-game" class="btn btn-secondary">Reset Game</button>
                <a href="{% url 'games:list' %}" class="btn btn-outline-primary">Back to Games</a>
            </div>

            {% if user.is_authenticated %}
            <div class="text-center mt-3">
                <small class="text-muted">Your scores are automatically saved!</small>
            </div>
            {% else %}
            <div class="text-center mt-3">
                <small class="text-muted">
                    <a href="{% url 'accounts:login' %}">Login</a> to save your scores!
                </small>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
class TicTacToe {
    constructor() {
        this.board = Array(9).fill('');
        this.currentPlayer = 'X';
        this.gameActive = true;
        this.winningConditions = [
            [0, 1, 2], [3, 4, 5], [6, 7, 8], // Rows
            [0, 3, 6], [1, 4, 7], [2, 5, 8], // Columns
            [0, 4, 8], [2, 4, 6] // Diagonals
        ];
        
        this.initializeGame();
    }

    initializeGame() {
        document.querySelectorAll('.tic-tac-toe-cell').forEach((cell, index) => {
            cell.addEventListener('click', () => this.handleCellClick(index));
        });
        
        document.getElementById('reset-game').addEventListener('click', () => this.resetGame());
        this.updateGameStatus();
    }

    handleCellClick(index) {
        if (this.board[index] !== '' || !this.gameActive) {
            return;
        }

        this.makeMove(index);
        this.checkResult();
    }

    makeMove(index) {
        this.board[index] = this.currentPlayer;
        document.querySelector(`[data-cell="${index}"]`).textContent = this.currentPlayer;
        document.querySelector(`[data-cell="${index}"]`).style.color = this.currentPlayer === 'X' ? '#007bff' : '#dc3545';
    }

    checkResult() {
        let roundWon = false;
        
        for (let i = 0; i < this.winningConditions.length; i++) {
            const [a, b, c] = this.winningConditions[i];
            if (this.board[a] && this.board[a] === this.board[b] && this.board[a] === this.board[c]) {
                roundWon = true;
                this.highlightWinningCells([a, b, c]);
                break;
            }
        }

        if (roundWon) {
            this.gameActive = false;
            this.updateGameStatus(`Player ${this.currentPlayer} wins! ðŸŽ‰`);
            this.saveScore(this.currentPlayer === 'X' ? 1 : 0);
            return;
        }

        if (!this.board.includes('')) {
            this.gameActive = false;
            this.updateGameStatus("Game ended in a draw! ðŸ¤");
            this.saveScore(0.5);
            return;
        }

        this.currentPlayer = this.currentPlayer === 'X' ? 'O' : 'X';
        this.updateGameStatus();
    }

    highlightWinningCells(cells) {
        cells.forEach(index => {
            document.querySelector(`[data-cell="${index}"]`).style.backgroundColor = '#28a745';
            document.querySelector(`[data-cell="${index}"]`).style.color = 'white';
        });
    }

    updateGameStatus(message = null) {
        const statusElement = document.getElementById('game-status');
        const playerElement = document.getElementById('current-player');
        
        if (message) {
            statusElement.textContent = message;
            playerElement.style.display = 'none';
        } else {
            statusElement.textContent = 'Make your move!';
            playerElement.innerHTML = `Current Player: <strong>${this.currentPlayer}</strong>`;
            playerElement.style.display = 'inline';
        }
    }

    saveScore(score) {
        {% if user.is_authenticated %}
        fetch('{% url "games:save_score" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                game_name: 'Tic Tac Toe',
                score: score
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Score saved successfully');
            }
        })
        .catch(error => console.error('Error saving score:', error));
        {% endif %}
    }

    resetGame() {
        this.board = Array(9).fill('');
        this.currentPlayer = 'X';
        this.gameActive = true;
        
        document.querySelectorAll('.tic-tac-toe-cell').forEach(cell => {
            cell.textContent = '';
            cell.style.backgroundColor = '';
            cell.style.color = '';
        });
        
        this.updateGameStatus();
    }
}

// Initialize the game when the page loads
document.addEventListener('DOMContentLoaded', function() {
    new TicTacToe();
});
</script>
{% endblock %}