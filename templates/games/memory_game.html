{% extends 'base.html' %}

{% block title %}Memory Game{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="game-area">
            <h1 class="text-center mb-4">üß† Memory Game</h1>
            
            <div class="text-center mb-3">
                <div class="score-display">
                    <span id="moves">Moves: <strong>0</strong></span>
                    <span class="mx-3">|</span>
                    <span id="matches">Matches: <strong>0/8</strong></span>
                    <span class="mx-3">|</span>
                    <span id="timer">Time: <strong>00:00</strong></span>
                </div>
                <div class="mt-2">
                    <span id="game-status">Click cards to find matching pairs! üÉè</span>
                </div>
            </div>

            <div class="memory-game-board" id="game-board">
                <!-- Cards will be generated by JavaScript -->
            </div>

            <div class="text-center mt-4">
                <button id="start-game" class="btn btn-success">Start Game</button>
                <button id="reset-game" class="btn btn-secondary">Reset</button>
                <a href="{% url 'games:list' %}" class="btn btn-outline-primary">Back to Games</a>
            </div>

            <div class="text-center mt-3">
                <small class="text-muted">
                    Find all 8 matching pairs by clicking on the cards!
                </small>
            </div>

            {% if user.is_authenticated %}
            <div class="text-center mt-3">
                <small class="text-muted">Your scores are automatically saved!</small>
            </div>
            {% else %}
            <div class="text-center mt-3">
                <small class="text-muted">
                    <a href="{% url 'accounts:login' %}">Login</a> to save your scores!
                </small>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.memory-game-board {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    grid-gap: 10px;
    max-width: 400px;
    margin: 0 auto;
    padding: 20px;
}

.memory-card {
    aspect-ratio: 1;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 2rem;
    color: white;
    transition: all 0.3s ease;
    border: 3px solid transparent;
    min-height: 80px;
}

.memory-card:hover {
    transform: scale(1.05);
    border-color: #fff;
}

.memory-card.flipped {
    background: #fff;
    color: #333;
    border-color: #007bff;
}

.memory-card.matched {
    background: #28a745;
    color: white;
    transform: scale(0.95);
    cursor: not-allowed;
}

.memory-card.disabled {
    cursor: not-allowed;
    pointer-events: none;
}

.score-display {
    font-size: 1.1rem;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
class MemoryGame {
    constructor() {
        this.cards = [];
        this.flippedCards = [];
        this.matchedPairs = 0;
        this.moves = 0;
        this.gameStarted = false;
        this.startTime = null;
        this.timer = null;
        
        this.symbols = ['üéÆ', 'üéØ', 'üé≤', 'üé™', 'üé®', 'üé≠', 'üé™', 'üéπ'];
        this.gameSymbols = [...this.symbols, ...this.symbols]; // Create pairs
        
        this.initializeGame();
    }

    initializeGame() {
        this.createBoard();
        
        document.getElementById('start-game').addEventListener('click', () => this.startGame());
        document.getElementById('reset-game').addEventListener('click', () => this.resetGame());
    }

    createBoard() {
        const board = document.getElementById('game-board');
        board.innerHTML = '';
        
        this.shuffleArray(this.gameSymbols);
        
        this.gameSymbols.forEach((symbol, index) => {
            const card = document.createElement('div');
            card.className = 'memory-card';
            card.dataset.symbol = symbol;
            card.dataset.index = index;
            card.textContent = '?';
            card.addEventListener('click', () => this.flipCard(card));
            board.appendChild(card);
        });
        
        this.cards = document.querySelectorAll('.memory-card');
    }

    shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    startGame() {
        if (!this.gameStarted) {
            this.gameStarted = true;
            this.startTime = Date.now();
            this.startTimer();
            document.getElementById('start-game').disabled = true;
            document.getElementById('game-status').textContent = 'Game started! Find the matching pairs! üß†';
        }
    }

    startTimer() {
        this.timer = setInterval(() => {
            const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
            const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
            const seconds = (elapsed % 60).toString().padStart(2, '0');
            document.getElementById('timer').innerHTML = `Time: <strong>${minutes}:${seconds}</strong>`;
        }, 1000);
    }

    flipCard(card) {
        if (!this.gameStarted || card.classList.contains('flipped') || 
            card.classList.contains('matched') || this.flippedCards.length >= 2) {
            return;
        }

        card.classList.add('flipped');
        card.textContent = card.dataset.symbol;
        this.flippedCards.push(card);

        if (this.flippedCards.length === 2) {
            this.moves++;
            this.updateMoves();
            this.checkMatch();
        }
    }

    checkMatch() {
        const [card1, card2] = this.flippedCards;
        
        if (card1.dataset.symbol === card2.dataset.symbol) {
            // Match found
            setTimeout(() => {
                card1.classList.add('matched');
                card2.classList.add('matched');
                this.matchedPairs++;
                this.updateMatches();
                this.flippedCards = [];
                
                if (this.matchedPairs === 8) {
                    this.gameWon();
                }
            }, 500);
        } else {
            // No match
            setTimeout(() => {
                card1.classList.remove('flipped');
                card2.classList.remove('flipped');
                card1.textContent = '?';
                card2.textContent = '?';
                this.flippedCards = [];
            }, 1000);
        }
    }

    updateMoves() {
        document.getElementById('moves').innerHTML = `Moves: <strong>${this.moves}</strong>`;
    }

    updateMatches() {
        document.getElementById('matches').innerHTML = `Matches: <strong>${this.matchedPairs}/8</strong>`;
    }

    gameWon() {
        clearInterval(this.timer);
        const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
        const score = Math.max(1000 - (this.moves * 10) - elapsed, 100);
        
        document.getElementById('game-status').textContent = `üéâ You won! Score: ${score}`;
        this.saveScore(score);
    }

    resetGame() {
        clearInterval(this.timer);
        this.flippedCards = [];
        this.matchedPairs = 0;
        this.moves = 0;
        this.gameStarted = false;
        this.startTime = null;
        
        document.getElementById('start-game').disabled = false;
        document.getElementById('game-status').textContent = 'Click cards to find matching pairs! üÉè';
        document.getElementById('timer').innerHTML = 'Time: <strong>00:00</strong>';
        
        this.updateMoves();
        this.updateMatches();
        this.createBoard();
    }

    saveScore(score) {
        {% if user.is_authenticated %}
        fetch('{% url "games:save_score" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                game_name: 'Memory Game',
                score: score
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Score saved successfully');
            }
        })
        .catch(error => console.error('Error saving score:', error));
        {% endif %}
    }
}

// Initialize the game when the page loads
document.addEventListener('DOMContentLoaded', function() {
    new MemoryGame();
});
</script>
{% endblock %}